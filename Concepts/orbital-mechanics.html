<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Mechanics • Physics Notebook</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/article.css">
    <style>
        /* AI Links */
        .ai-links {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            align-items: center;
        }

        .ai-label {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-right: 0.2rem;
            font-weight: 500;
        }

        .ai-btn {
            background: var(--bg-color);
            border: 1px solid var(--line-subtle);
            color: var(--text-muted);
            min-width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 8px;
        }

        .ai-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--line-subtle);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--accent);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }
    </style>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Theme Init -->
    <script>
        const savedTheme = localStorage.getItem('physics-notebook-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body && document.body.setAttribute('data-theme', savedTheme);
    </script>

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>

    <nav class="sticky">
        <div class="nav-bg"></div>
        <a href="../index.html" class="logo">
            <i data-lucide="arrow-left" width="16"></i>
            Library
        </a>
        <button id="themeBtn">
            <i data-lucide="moon" width="16"></i> Theme
        </button>
    </nav>

    <!-- HERO -->
    <section class="hero">
        <div class="text-reveal-wrapper">
            <h1 class="hero-title">Orbital<br>Mechanics</h1>
            <p style="margin-top: 2rem; font-size: 1.4rem; max-width: 40ch;">
                Exploring the celestial dance governed by Kepler's Laws and Newton's Universal Gravitation.
            </p>
        </div>
    </section>

    <!-- CHAPTER 1: KEPLER'S LAWS -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--accent);">01. The Motion</h3>
                <h2>Kepler's Laws</h2>
                <p>
                    Johannes Kepler discovered that planets move in <strong>elliptical orbits</strong> with the Sun at
                    one
                    focus. This observation fundamentally changed our understanding of the solar system.
                </p>
                <div class="math-block">
                    $$r = \frac{p}{1 + e \cos \theta}$$
                </div>
                <p>
                    His second law states that a line segment joining a planet and the Sun sweeps out equal areas during
                    equal intervals of time. This means planets move faster when they are closer to the Sun (perihelion)
                    and slower when they are farther away (aphelion).
                </p>
                <!-- SIM CONTROLS: KEPLER -->
                <div class="sim-controls">
                    <div class="slider-group">
                        <label>Eccentricity ($e$) <span id="val-eccentricity">0.6</span></label>
                        <input type="range" id="input-eccentricity" min="0.0" max="0.8" step="0.05" value="0.6">
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <label style="font-weight: 500;">Show Sweep Area</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-sweep">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- ETU CARD -->
                <div class="etu-card">
                    <span class="etu-tag">Real World Analogy</span>
                    <h4 style="margin-bottom:0.5rem;">The Ice Skater</h4>
                    <p style="font-size: 0.95rem; margin-bottom:0;">
                        Think of a figure skater spinning. As they pull their arms in (reducing distance/radius), they
                        spin faster to conserve angular momentum. Similarly, as a planet gets closer to the Sun, it
                        speeds up.
                    </p>
                </div>

                <!-- AI LINKS -->
                <div class="ai-links">
                    <span class="ai-label">Ask AI:</span>
                    <button onclick="openAI('kepler', 'perplexity')" class="ai-btn" title="Ask Perplexity">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.3977 7.0896h-2.3106V.0676l-7.5094 6.3542V.1577h-1.1554v6.1966L4.4904 0v7.0896H1.6023v10.3976h2.8882V24l6.932-6.3591v6.2005h1.1554v-6.0469l6.9318 6.1807v-6.4879h2.8882V7.0896zm-3.4657-4.531v4.531h-5.355l5.355-4.531zm-13.2862.0676 4.8691 4.4634H5.6458V2.6262zM2.7576 16.332V8.245h7.8476l-6.1149 6.1147v1.9723H2.7576zm2.8882 5.0404v-3.8852h.0001v-2.6488l5.7763-5.7764v7.0111l-5.7764 5.2993zm12.7086.0248-5.7766-5.1509V9.0618l5.7766 5.7766v6.5588zm2.8882-5.0652h-1.733v-1.9723L13.3948 8.245h7.8478v8.087z" />
                        </svg>
                    </button>
                    <button onclick="openAI('kepler', 'gemini')" class="ai-btn" title="Ask Gemini">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11.04 19.32Q12 21.51 12 24q0-2.49.93-4.68.96-2.19 2.58-3.81t3.81-2.55Q21.51 12 24 12q-2.49 0-4.68-.93a12.3 12.3 0 0 1-3.81-2.58 12.3 12.3 0 0 1-2.58-3.81Q12 2.49 12 0q0 2.49-.96 4.68-.93 2.19-2.55 3.81a12.3 12.3 0 0 1-3.81 2.58Q2.49 12 0 12q2.49 0 4.68.96 2.19.93 3.81 2.55t2.55 3.81" />
                        </svg>
                    </button>
                    <button onclick="openAI('kepler', 'chatgpt')" class="ai-btn" title="Ask ChatGPT">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
                        </svg>
                    </button>
                    <button onclick="openAI('kepler', 'claude')" class="ai-btn" title="Ask Claude">
                        <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.64">
                            <path fill="#D77655"
                                d="M115.612 0h280.775C459.974 0 512 52.026 512 115.612v278.415c0 63.587-52.026 115.612-115.613 115.612H115.612C52.026 509.639 0 457.614 0 394.027V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#FCF2EE" fill-rule="nonzero"
                                d="M142.27 316.619l73.655-41.326 1.238-3.589-1.238-1.996-3.589-.001-12.31-.759-42.084-1.138-36.498-1.516-35.361-1.896-8.897-1.895-8.34-10.995.859-5.484 7.482-5.03 10.717.935 23.683 1.617 35.537 2.452 25.782 1.517 38.193 3.968h6.064l.86-2.451-2.073-1.517-1.618-1.517-36.776-24.922-39.81-26.338-20.852-15.166-11.273-7.683-5.687-7.204-2.451-15.721 10.237-11.273 13.75.935 3.513.936 13.928 10.716 29.749 23.027 38.848 28.612 5.687 4.727 2.275-1.617.278-1.138-2.553-4.271-21.13-38.193-22.546-38.848-10.035-16.101-2.654-9.655c-.935-3.968-1.617-7.304-1.617-11.374l11.652-15.823 6.445-2.073 15.545 2.073 6.547 5.687 9.655 22.092 15.646 34.78 24.265 47.291 7.103 14.028 3.791 12.992 1.416 3.968 2.449-.001v-2.275l1.997-26.641 3.69-32.707 3.589-42.084 1.239-11.854 5.863-14.206 11.652-7.683 9.099 4.348 7.482 10.716-1.036 6.926-4.449 28.915-8.72 45.294-5.687 30.331h3.313l3.792-3.791 15.342-20.372 25.782-32.227 11.374-12.789 13.27-14.129 8.517-6.724 16.1-.001 11.854 17.617-5.307 18.199-16.581 21.029-13.75 17.819-19.716 26.54-12.309 21.231 1.138 1.694 2.932-.278 44.536-9.479 24.062-4.347 28.714-4.928 12.992 6.066 1.416 6.167-5.106 12.613-30.71 7.583-36.018 7.204-53.636 12.689-.657.48.758.935 24.164 2.275 10.337.556h25.301l47.114 3.514 12.309 8.139 7.381 9.959-1.238 7.583-18.957 9.655-25.579-6.066-59.702-14.205-20.474-5.106-2.83-.001v1.694l17.061 16.682 31.266 28.233 39.152 36.397 1.997 8.999-5.03 7.102-5.307-.758-34.401-25.883-13.27-11.651-30.053-25.302-1.996-.001v2.654l6.926 10.136 36.574 54.975 1.895 16.859-2.653 5.485-9.479 3.311-10.414-1.895-21.408-30.054-22.092-33.844-17.819-30.331-2.173 1.238-10.515 113.261-4.929 5.788-11.374 4.348-9.478-7.204-5.03-11.652 5.03-23.027 6.066-30.052 4.928-23.886 4.449-29.674 2.654-9.858-.177-.657-2.173.278-22.37 30.71-34.021 45.977-26.919 28.815-6.445 2.553-11.173-5.789 1.037-10.337 6.243-9.2 37.257-47.392 22.47-29.371 14.508-16.961-.101-2.451h-.859l-98.954 64.251-17.618 2.275-7.583-7.103.936-11.652 3.589-3.791 29.749-20.474-.101.102.024.101z" />
                        </svg>
                    </button>
                    <button onclick="openAI('kepler', 'grok')" class="ai-btn" title="Ask Grok">
                        <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.641">
                            <path
                                d="M115.612 0h280.776C459.975 0 512 52.026 512 115.612v278.416c0 63.587-52.025 115.613-115.612 115.613H115.612C52.026 509.641 0 457.615 0 394.028V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#fff"
                                d="M213.235 306.019l178.976-180.002v.169l51.695-51.763c-.924 1.32-1.86 2.605-2.785 3.89-39.281 54.164-58.46 80.649-43.07 146.922l-.09-.101c10.61 45.11-.744 95.137-37.398 131.836-46.216 46.306-120.167 56.611-181.063 14.928l42.462-19.675c38.863 15.278 81.392 8.57 111.947-22.03 30.566-30.6 37.432-75.159 22.065-112.252-2.92-7.025-11.67-8.795-17.792-4.263l-124.947 92.341zm-25.786 22.437l-.033.034L68.094 435.217c7.565-10.429 16.957-20.294 26.327-30.149 26.428-27.803 52.653-55.359 36.654-94.302-21.422-52.112-8.952-113.177 30.724-152.898 41.243-41.254 101.98-51.661 152.706-30.758 11.23 4.172 21.016 10.114 28.638 15.639l-42.359 19.584c-39.44-16.563-84.629-5.299-112.207 22.313-37.298 37.308-44.84 102.003-1.128 143.81z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-kepler"></canvas>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- CHAPTER 2: GRAVITY -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--accent-secondary);">02. The Force</h3>
                <h2>Universal Gravitation</h2>
                <p>
                    Isaac Newton unified the motion of planets with the falling of an apple. He proposed that every
                    particle
                    attracts every other particle with a force directly proportional to the product of their masses and
                    inversely proportional to the square of the distance between them.
                </p>
                <div class="math-block">
                    $$F = G \frac{m_1 m_2}{r^2}$$
                </div>
                <p>
                    Where $G$ is the gravitational constant. This inverse-square law enables the stable, elliptical
                    orbits
                    we observe in the cosmos.
                </p>
                <!-- SIM CONTROLS: GRAVITY -->
                <div class="sim-controls">
                    <div class="slider-group">
                        <label>Mass 1 ($m_1$) <span id="val-m1">40</span></label>
                        <input type="range" id="input-m1" min="10" max="80" step="5" value="40">
                    </div>
                    <div class="slider-group">
                        <label>Mass 2 ($m_2$) <span id="val-m2">20</span></label>
                        <input type="range" id="input-m2" min="5" max="40" step="5" value="20">
                    </div>
                    <div class="slider-group">
                        <label>Distance ($r$) <span id="val-r">150</span></label>
                        <input type="range" id="input-r" min="80" max="250" step="10" value="150">
                    </div>
                </div>

                <!-- ETU CARD -->
                <div class="etu-card">
                    <span class="etu-tag">Real World Analogy</span>
                    <h4 style="margin-bottom:0.5rem;">The Tetherball</h4>
                    <p style="font-size: 0.95rem; margin-bottom:0;">
                        Gravity acts like the rope in tetherball, constantly pulling the ball toward the pole (center).
                        Without this pull, the ball would fly off in a straight line.
                    </p>
                </div>

                <!-- AI LINKS -->
                <div class="ai-links">
                    <span class="ai-label">Ask AI:</span>
                    <button onclick="openAI('gravity', 'perplexity')" class="ai-btn" title="Ask Perplexity">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.3977 7.0896h-2.3106V.0676l-7.5094 6.3542V.1577h-1.1554v6.1966L4.4904 0v7.0896H1.6023v10.3976h2.8882V24l6.932-6.3591v6.2005h1.1554v-6.0469l6.9318 6.1807v-6.4879h2.8882V7.0896zm-3.4657-4.531v4.531h-5.355l5.355-4.531zm-13.2862.0676 4.8691 4.4634H5.6458V2.6262zM2.7576 16.332V8.245h7.8476l-6.1149 6.1147v1.9723H2.7576zm2.8882 5.0404v-3.8852h.0001v-2.6488l5.7763-5.7764v7.0111l-5.7764 5.2993zm12.7086.0248-5.7766-5.1509V9.0618l5.7766 5.7766v6.5588zm2.8882-5.0652h-1.733v-1.9723L13.3948 8.245h7.8478v8.087z" />
                        </svg>
                    </button>
                    <button onclick="openAI('gravity', 'gemini')" class="ai-btn" title="Ask Gemini">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11.04 19.32Q12 21.51 12 24q0-2.49.93-4.68.96-2.19 2.58-3.81t3.81-2.55Q21.51 12 24 12q-2.49 0-4.68-.93a12.3 12.3 0 0 1-3.81-2.58 12.3 12.3 0 0 1-2.58-3.81Q12 2.49 12 0q0 2.49-.96 4.68-.93 2.19-2.55 3.81a12.3 12.3 0 0 1-3.81 2.58Q2.49 12 0 12q2.49 0 4.68.96 2.19.93 3.81 2.55t2.55 3.81" />
                        </svg>
                    </button>
                    <button onclick="openAI('gravity', 'chatgpt')" class="ai-btn" title="Ask ChatGPT">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
                        </svg>
                    </button>
                    <button onclick="openAI('gravity', 'claude')" class="ai-btn" title="Ask Claude">
                        <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.64">
                            <path fill="#D77655"
                                d="M115.612 0h280.775C459.974 0 512 52.026 512 115.612v278.415c0 63.587-52.026 115.612-115.613 115.612H115.612C52.026 509.639 0 457.614 0 394.027V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#FCF2EE" fill-rule="nonzero"
                                d="M142.27 316.619l73.655-41.326 1.238-3.589-1.238-1.996-3.589-.001-12.31-.759-42.084-1.138-36.498-1.516-35.361-1.896-8.897-1.895-8.34-10.995.859-5.484 7.482-5.03 10.717.935 23.683 1.617 35.537 2.452 25.782 1.517 38.193 3.968h6.064l.86-2.451-2.073-1.517-1.618-1.517-36.776-24.922-39.81-26.338-20.852-15.166-11.273-7.683-5.687-7.204-2.451-15.721 10.237-11.273 13.75.935 3.513.936 13.928 10.716 29.749 23.027 38.848 28.612 5.687 4.727 2.275-1.617.278-1.138-2.553-4.271-21.13-38.193-22.546-38.848-10.035-16.101-2.654-9.655c-.935-3.968-1.617-7.304-1.617-11.374l11.652-15.823 6.445-2.073 15.545 2.073 6.547 5.687 9.655 22.092 15.646 34.78 24.265 47.291 7.103 14.028 3.791 12.992 1.416 3.968 2.449-.001v-2.275l1.997-26.641 3.69-32.707 3.589-42.084 1.239-11.854 5.863-14.206 11.652-7.683 9.099 4.348 7.482 10.716-1.036 6.926-4.449 28.915-8.72 45.294-5.687 30.331h3.313l3.792-3.791 15.342-20.372 25.782-32.227 11.374-12.789 13.27-14.129 8.517-6.724 16.1-.001 11.854 17.617-5.307 18.199-16.581 21.029-13.75 17.819-19.716 26.54-12.309 21.231 1.138 1.694 2.932-.278 44.536-9.479 24.062-4.347 28.714-4.928 12.992 6.066 1.416 6.167-5.106 12.613-30.71 7.583-36.018 7.204-53.636 12.689-.657.48.758.935 24.164 2.275 10.337.556h25.301l47.114 3.514 12.309 8.139 7.381 9.959-1.238 7.583-18.957 9.655-25.579-6.066-59.702-14.205-20.474-5.106-2.83-.001v1.694l17.061 16.682 31.266 28.233 39.152 36.397 1.997 8.999-5.03 7.102-5.307-.758-34.401-25.883-13.27-11.651-30.053-25.302-1.996-.001v2.654l6.926 10.136 36.574 54.975 1.895 16.859-2.653 5.485-9.479 3.311-10.414-1.895-21.408-30.054-22.092-33.844-17.819-30.331-2.173 1.238-10.515 113.261-4.929 5.788-11.374 4.348-9.478-7.204-5.03-11.652 5.03-23.027 6.066-30.052 4.928-23.886 4.449-29.674 2.654-9.858-.177-.657-2.173.278-22.37 30.71-34.021 45.977-26.919 28.815-6.445 2.553-11.173-5.789 1.037-10.337 6.243-9.2 37.257-47.392 22.47-29.371 14.508-16.961-.101-2.451h-.859l-98.954 64.251-17.618 2.275-7.583-7.103.936-11.652 3.589-3.791 29.749-20.474-.101.102.024.101z" />
                        </svg>
                    </button>
                    <button onclick="openAI('gravity', 'grok')" class="ai-btn" title="Ask Grok">
                        <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.641">
                            <path
                                d="M115.612 0h280.776C459.975 0 512 52.026 512 115.612v278.416c0 63.587-52.025 115.613-115.612 115.613H115.612C52.026 509.641 0 457.615 0 394.028V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#fff"
                                d="M213.235 306.019l178.976-180.002v.169l51.695-51.763c-.924 1.32-1.86 2.605-2.785 3.89-39.281 54.164-58.46 80.649-43.07 146.922l-.09-.101c10.61 45.11-.744 95.137-37.398 131.836-46.216 46.306-120.167 56.611-181.063 14.928l42.462-19.675c38.863 15.278 81.392 8.57 111.947-22.03 30.566-30.6 37.432-75.159 22.065-112.252-2.92-7.025-11.67-8.795-17.792-4.263l-124.947 92.341zm-25.786 22.437l-.033.034L68.094 435.217c7.565-10.429 16.957-20.294 26.327-30.149 26.428-27.803 52.653-55.359 36.654-94.302-21.422-52.112-8.952-113.177 30.724-152.898 41.243-41.254 101.98-51.661 152.706-30.758 11.23 4.172 21.016 10.114 28.638 15.639l-42.359 19.584c-39.44-16.563-84.629-5.299-112.207 22.313-37.298 37.308-44.84 102.003-1.128 143.81z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-gravity"></canvas>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <!-- CHAPTER 3: ORBIT SIMULATION -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--text-muted);">03. Simulation</h3>
                <h2>Orbits in Action</h2>
                <p>
                    Adjust the initial velocity and mass to see how they affect the orbit. Too slow, and the planet
                    crashes
                    into the star. Too fast, and it escapes into deep space (hyperbolic trajectory).
                </p>
                <div class="sim-controls">
                    <div class="slider-group">
                        <label>Initial Velocity ($v$) <span id="val-v">3.0</span></label>
                        <input type="range" id="input-v" min="1.0" max="6.0" step="0.1" value="3.0">
                    </div>
                    <div class="slider-group">
                        <label>Mass of Planet ($m$) <span id="val-m">1.0</span></label>
                        <input type="range" id="input-m" min="0.5" max="5.0" step="0.5" value="1.0">
                    </div>
                    <div
                        style="margin-top:0.5rem; text-align:right; display:flex; gap:0.5rem; justify-content:flex-end;">
                        <button id="btn-clear-trail"
                            style="padding:8px 16px; background:var(--bg-color); color:var(--text-main); border:1px solid var(--line-subtle); border-radius:4px; cursor:pointer;">Clear
                            Trail</button>
                        <button id="btn-reset"
                            style="padding:8px 16px; background:var(--text-main); color:var(--bg-color); border:none; border-radius:4px; cursor:pointer;">Reset
                            System</button>
                    </div>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-orbit"></canvas>
            </div>
        </div>
    </section>

    <section class="references">
        <div style="max-width: 800px; margin: 0 auto;">
            <h3>Academic References</h3>
            <ul>
                <li><strong>Thornton, S. T., & Marion, J. B.</strong> (2003). <em>Classical Dynamics of Particles and
                        Systems</em>.</li>
                <li><strong>Murray, C. D., & Dermott, S. F.</strong> <em>Solar System Dynamics</em>, Chapter 2.</li>
            </ul>
        </div>
    </section>

    <!-- Scripts -->
    <script src="../js/common.js"></script>
    <script>
        function openAI(topic, model) {
            let prompt = "";
            switch (topic) {
                case 'kepler':
                    prompt = "Explain Kepler's laws of planetary motion in simple terms.";
                    break;
                case 'gravity':
                    prompt = "Explain Newton's law of universal gravitation and how it governs planetary orbits.";
                    break;
            }
            const encoded = encodeURIComponent(prompt);

            if (model === 'gemini') {
                navigator.clipboard.writeText(prompt).then(() => {
                    alert("Gemini doesn't support auto-fill. The prompt has been copied to your clipboard.");
                    window.open('https://gemini.google.com/app', '_blank');
                });
                return;
            }

            let url = "";
            switch (model) {
                case 'perplexity': url = `https://www.perplexity.ai/search?q=${encoded}`; break;
                case 'chatgpt': url = `https://chatgpt.com/?q=${encoded}`; break;
                case 'claude': url = `https://claude.ai/new?q=${encoded}`; break;
                case 'grok': url = `https://grok.com/?q=${encoded}`; break;
            }
            if (url) window.open(url, '_blank');
        }

        const APP = {
            visuals: [],
            observer: null,

            init() {
                this.setupObserver();
                this.initScrollAnimations();
                this.initVisuals();

                window.addEventListener('theme-changed', (e) => {
                    this.visuals.forEach(v => v.updateColors());
                });
            },

            setupObserver() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const visual = this.visuals.find(v => v.canvas === entry.target);
                        if (visual) visual.isVisible = entry.isIntersecting;
                    });
                }, { threshold: 0.1 });
            },

            initScrollAnimations() {
                gsap.registerPlugin(ScrollTrigger);
                gsap.utils.toArray('h1, h2, h3').forEach(el => {
                    gsap.from(el, { opacity: 0, y: 30, duration: 1.2, ease: "power3.out", scrollTrigger: { trigger: el, start: "top 85%" } });
                });
                gsap.utils.toArray('.math-block').forEach(el => {
                    gsap.from(el, { scale: 0.95, opacity: 0, duration: 1, ease: "power2.out", scrollTrigger: { trigger: el, start: "top 90%" } });
                });
            },

            initVisuals() {
                this.addVisual(new KeplerVisual('canvas-kepler'));
                this.addVisual(new GravityVisual('canvas-gravity'));
                this.addVisual(new OrbitSimulation('canvas-orbit'));
            },

            addVisual(visual) {
                this.visuals.push(visual);
                this.observer.observe(visual.canvas);
            }
        };

        class BaseVisual {
            constructor(id) {
                this.canvas = document.getElementById(id);
                this.ctx = this.canvas.getContext('2d');
                this.isVisible = false;
                this.updateColors();
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop();
            }
            updateColors() {
                this.color = getComputedStyle(document.body).getPropertyValue('--text-main').trim();
                this.bg = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
                this.accent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
                this.secondary = getComputedStyle(document.body).getPropertyValue('--accent-secondary').trim();
            }
            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width * 2;
                this.canvas.height = rect.height * 2;
                this.scale = 2;
                this.cx = this.canvas.width / 2;
                this.cy = this.canvas.height / 2;
            }
            loop() {
                if (this.isVisible) this.draw();
                requestAnimationFrame(() => this.loop());
            }
            draw() { }
        }

        class KeplerVisual extends BaseVisual {
            constructor(id) {
                super(id);
                this.time = 0;
                this.e = 0.6;
                this.showSweep = false;

                const eInput = document.getElementById('input-eccentricity');
                const sweepToggle = document.getElementById('toggle-sweep');

                if (eInput) eInput.addEventListener('input', (e) => {
                    this.e = parseFloat(e.target.value);
                    document.getElementById('val-eccentricity').textContent = this.e;
                });
                if (sweepToggle) sweepToggle.addEventListener('change', (e) => {
                    this.showSweep = e.target.checked;
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.time += 0.015;

                const a = 150 * this.scale;
                const e = this.e;
                const b = a * Math.sqrt(1 - e * e);
                const c = a * e;

                const sunX = this.cx + c;
                const sunY = this.cy;

                // Orbit path
                this.ctx.strokeStyle = 'rgba(128,128,128,0.2)';
                this.ctx.lineWidth = 1 * this.scale;
                this.ctx.beginPath();
                this.ctx.ellipse(this.cx, this.cy, a, b, 0, 0, Math.PI * 2);
                this.ctx.stroke();

                // Empty Focus
                this.ctx.fillStyle = this.color;
                this.ctx.globalAlpha = 0.3;
                this.ctx.beginPath();
                this.ctx.arc(this.cx - c, this.cy, 3 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.globalAlpha = 1.0;

                // Solve Kepler's Equation: M = E - e*sin(E) using Newton-Raphson
                const M = this.time % (Math.PI * 2);
                let E = M;
                for (let i = 0; i < 5; i++) {
                    E = E - (E - e * Math.sin(E) - M) / (1 - e * Math.cos(E));
                }

                // True anomaly (nu) & Radius (r)
                const nu = 2 * Math.atan(Math.sqrt((1 + e) / (1 - e)) * Math.tan(E / 2));
                const r = a * (1 - e * e) / (1 + e * Math.cos(nu));

                const planetX = sunX + r * Math.cos(nu);
                const planetY = sunY + r * Math.sin(nu);

                // Sweep Area
                if (this.showSweep) {
                    this.ctx.fillStyle = this.secondary;
                    this.ctx.globalAlpha = 0.2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(sunX, sunY);

                    const sweepM = 0.5;
                    for (let step = 0; step <= 20; step++) {
                        let tempM = M - sweepM * (step / 20);
                        let tempE = tempM;
                        for (let i = 0; i < 5; i++) tempE = tempE - (tempE - e * Math.sin(tempE) - tempM) / (1 - e * Math.cos(tempE));
                        let tempNu = 2 * Math.atan(Math.sqrt((1 + e) / (1 - e)) * Math.tan(tempE / 2));
                        let tempR = a * (1 - e * e) / (1 + e * Math.cos(tempNu));
                        this.ctx.lineTo(sunX + tempR * Math.cos(tempNu), sunY + tempR * Math.sin(tempNu));
                    }
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.globalAlpha = 1.0;
                }

                // Velocity Vector
                const ndt = 40;
                const dEdt = 1 / (1 - e * Math.cos(E));
                const vx = -a * Math.sin(E) * dEdt;
                const vy = b * Math.cos(E) * dEdt;

                this.ctx.strokeStyle = this.accent;
                this.ctx.lineWidth = 2 * this.scale;
                if (typeof drawArrow === "function") {
                    drawArrow(this.ctx, planetX, planetY, planetX + vx * ndt * this.scale / a, planetY + vy * ndt * this.scale / a, 6 * this.scale);
                }

                // Sun
                this.ctx.fillStyle = this.accent;
                this.ctx.beginPath();
                this.ctx.arc(sunX, sunY, 15 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();

                // Planet
                this.ctx.fillStyle = this.color;
                this.ctx.beginPath();
                this.ctx.arc(planetX, planetY, 8 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();
            }
        }

        class GravityVisual extends BaseVisual {
            constructor(id) {
                super(id);
                this.dist = 150;
                this.m1 = 40;
                this.m2 = 20;
                this.cacheCanvas = document.createElement('canvas');
                this.cacheCanvas.width = 0;

                const m1Input = document.getElementById('input-m1');
                const m2Input = document.getElementById('input-m2');
                const rInput = document.getElementById('input-r');

                if (m1Input) m1Input.addEventListener('input', (e) => {
                    this.m1 = parseInt(e.target.value);
                    document.getElementById('val-m1').textContent = this.m1;
                    this.updateCache = true;
                });
                if (m2Input) m2Input.addEventListener('input', (e) => {
                    this.m2 = parseInt(e.target.value);
                    document.getElementById('val-m2').textContent = this.m2;
                    this.updateCache = true;
                });
                if (rInput) rInput.addEventListener('input', (e) => {
                    this.dist = parseInt(e.target.value);
                    document.getElementById('val-r').textContent = this.dist;
                    this.updateCache = true;
                });
                this.updateCache = true;
            }

            resize() {
                super.resize();
                if (this.cacheCanvas) {
                    this.cacheCanvas.width = this.canvas.width;
                    this.cacheCanvas.height = this.canvas.height;
                    this.updateCache = true;
                }
            }

            draw() {
                const dist = this.dist;
                const p1x = this.cx - dist * this.scale / 2;
                const p2x = this.cx + dist * this.scale / 2;

                if (this.updateCache && this.cacheCanvas.width > 0) {
                    const ctx = this.cacheCanvas.getContext('2d');
                    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    const resolution = 6 * this.scale;
                    ctx.fillStyle = this.secondary;

                    for (let x = 0; x < this.canvas.width; x += resolution) {
                        for (let y = 0; y < this.canvas.height; y += resolution) {
                            const dx1 = x - p1x;
                            const dy1 = y - this.cy;
                            const r1 = Math.sqrt(dx1 * dx1 + dy1 * dy1) || 1;

                            const dx2 = x - p2x;
                            const dy2 = y - this.cy;
                            const r2 = Math.sqrt(dx2 * dx2 + dy2 * dy2) || 1;

                            const potential = (this.m1 / r1) + (this.m2 / r2);
                            const intensity = Math.min(potential * 3, 1.0);

                            if (intensity > 0.05) {
                                ctx.globalAlpha = intensity * 0.4;
                                ctx.fillRect(x, y, resolution, resolution);
                            }
                        }
                    }
                    ctx.globalAlpha = 1.0;
                    this.updateCache = false;
                }

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.cacheCanvas.width > 0) {
                    this.ctx.drawImage(this.cacheCanvas, 0, 0);
                }

                const G_vis = 5000;
                const force = G_vis * (this.m1 * this.m2) / (dist * dist);
                const vecLen = Math.min(force * this.scale, 120 * this.scale);

                this.ctx.fillStyle = this.accent;
                this.ctx.beginPath();
                this.ctx.arc(p1x, this.cy, Math.sqrt(this.m1) * 3 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.fillStyle = this.color;
                this.ctx.beginPath();
                this.ctx.arc(p2x, this.cy, Math.sqrt(this.m2) * 3 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.strokeStyle = this.secondary;
                this.ctx.lineWidth = 3 * this.scale;
                if (typeof drawArrow === "function") {
                    drawArrow(this.ctx, p1x, this.cy, p1x + vecLen, this.cy, 10 * this.scale);
                    drawArrow(this.ctx, p2x, this.cy, p2x - vecLen, this.cy, 10 * this.scale);
                }

                this.ctx.fillStyle = this.color;
                this.ctx.font = `${14 * this.scale}px Inter`;
                this.ctx.textAlign = "center";
                this.ctx.fillText(`r = ${Math.round(dist)}`, this.cx, this.cy - (Math.sqrt(this.m1) * 3 * this.scale) - 10 * this.scale);
                this.ctx.fillStyle = this.secondary;
                this.ctx.fillText(`F ∝ ${Math.round(force)}`, this.cx, this.cy + 30 * this.scale);
            }
        }

        function drawArrow(ctx, x1, y1, x2, y2, headLen = 10) {
            const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI / 6), y2 - headLen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI / 6), y2 - headLen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fill();
        }

        class OrbitSimulation extends BaseVisual {
            constructor(id) {
                super(id);
                this.G = 300;
                this.reset();

                const vInput = document.getElementById('input-v');
                const mInput = document.getElementById('input-m');
                const btnReset = document.getElementById('btn-reset');
                const btnClear = document.getElementById('btn-clear-trail');

                if (vInput) vInput.addEventListener('input', (e) => {
                    document.getElementById('val-v').innerText = parseFloat(e.target.value).toFixed(1);
                    this.reset();
                });
                if (mInput) mInput.addEventListener('input', (e) => {
                    document.getElementById('val-m').innerText = parseFloat(e.target.value).toFixed(1);
                    this.reset();
                });
                if (btnReset) btnReset.addEventListener('click', () => this.reset());
                if (btnClear) btnClear.addEventListener('click', () => { this.path = []; });
            }

            reset() {
                const vx_input = parseFloat(document.getElementById('input-v')?.value || 3.0);
                const m_input = parseFloat(document.getElementById('input-m')?.value || 1.0);

                this.planet = {
                    x: 0,
                    y: -150,
                    vx: vx_input * 2,
                    vy: 0,
                    mass: m_input
                };
                this.sun = {
                    x: 0,
                    y: 0,
                    mass: 50
                };
                this.path = [];

                const rSq = Math.max(1, (this.sun.x - this.planet.x) ** 2 + (this.sun.y - this.planet.y) ** 2);
                const r = Math.sqrt(rSq);
                const F = (this.G * this.sun.mass) / rSq;
                this.planet.ax = F * (this.sun.x - this.planet.x) / r;
                this.planet.ay = F * (this.sun.y - this.planet.y) / r;
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                const dt = 0.05;
                const steps = 10;

                for (let i = 0; i < steps; i++) {
                    const p = this.planet;

                    p.x += p.vx * dt + 0.5 * p.ax * dt * dt;
                    p.y += p.vy * dt + 0.5 * p.ay * dt * dt;

                    const dx = this.sun.x - p.x;
                    const dy = this.sun.y - p.y;
                    const distSq = Math.max(1, dx * dx + dy * dy);
                    const dist = Math.sqrt(distSq);

                    if (dist < 15) {
                        p.vx *= 0.8;
                        p.vy *= 0.8;
                        continue;
                    }

                    const F = (this.G * this.sun.mass) / distSq;
                    const new_ax = F * (dx / dist);
                    const new_ay = F * (dy / dist);

                    p.vx += 0.5 * (p.ax + new_ax) * dt;
                    p.vy += 0.5 * (p.ay + new_ay) * dt;

                    p.ax = new_ax;
                    p.ay = new_ay;
                }

                if (this.path.length === 0 || Math.hypot(this.path[this.path.length - 1].x - this.planet.x, this.path[this.path.length - 1].y - this.planet.y) > 3) {
                    this.path.push({ x: this.planet.x, y: this.planet.y });
                    if (this.path.length > 700) this.path.shift();
                }

                const sunScreenX = this.cx + this.sun.x * this.scale;
                const sunScreenY = this.cy + this.sun.y * this.scale;
                const pScreenX = this.cx + this.planet.x * this.scale;
                const pScreenY = this.cy + this.planet.y * this.scale;

                this.ctx.strokeStyle = this.color;
                this.ctx.globalAlpha = 0.3;
                this.ctx.lineWidth = 1 * this.scale;
                this.ctx.beginPath();
                this.path.forEach((p, i) => {
                    const px = this.cx + p.x * this.scale;
                    const py = this.cy + p.y * this.scale;
                    if (i === 0) this.ctx.moveTo(px, py); else this.ctx.lineTo(px, py);
                });
                this.ctx.stroke();
                this.ctx.globalAlpha = 1.0;

                const vScale = 3 * this.scale;
                this.ctx.strokeStyle = this.accent;
                this.ctx.lineWidth = 2 * this.scale;
                if (typeof drawArrow === "function") {
                    drawArrow(this.ctx, pScreenX, pScreenY, pScreenX + this.planet.vx * vScale, pScreenY + this.planet.vy * vScale, 6 * this.scale);
                }

                this.ctx.fillStyle = this.accent;
                this.ctx.beginPath();
                this.ctx.arc(sunScreenX, sunScreenY, 20 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = this.accent;
                this.ctx.fill();
                this.ctx.shadowBlur = 0;

                this.ctx.fillStyle = this.secondary;
                this.ctx.beginPath();
                this.ctx.arc(pScreenX, pScreenY, (5 + this.planet.mass) * this.scale, 0, Math.PI * 2);
                this.ctx.fill();
            }
        }

        window.onload = () => APP.init();

    </script>
</body>

</html>