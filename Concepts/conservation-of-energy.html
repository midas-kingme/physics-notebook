<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conservation of Energy • Physics Notebook</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/article.css">
    <style>
        /* AI Links */
        .ai-links {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            align-items: center;
        }

        .ai-label {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-right: 0.2rem;
            font-weight: 500;
        }

        .ai-btn {
            background: var(--bg-color);
            border: 1px solid var(--line-subtle);
            color: var(--text-muted);
            min-width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0 8px;
        }

        .ai-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Mobile specific adjustments to ensure controls are stacked above canvas */
        @media screen and (max-width: 900px) {
            .split-layout {
                display: flex;
                flex-direction: column;
            }

            .content-col {
                order: 1;
                /* Content and controls on top */
            }

            .visual-col {
                order: 2;
                /* Canvas on bottom */
                min-height: 400px;
            }

            .sim-controls {
                margin-top: 2rem;
                margin-bottom: 2rem;
                /* Add space below controls before the canvas */
            }
        }
    </style>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Theme Init -->
    <script>
        const savedTheme = localStorage.getItem('physics-notebook-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body && document.body.setAttribute('data-theme', savedTheme);
    </script>

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>

    <nav class="sticky">
        <div class="nav-bg"></div>
        <a href="../index.html" class="logo">
            <i data-lucide="arrow-left" width="16"></i>
            Library
        </a>
        <button id="themeBtn">
            <i data-lucide="moon" width="16"></i> Theme
        </button>
    </nav>

    <!-- HERO -->
    <section class="hero">
        <div class="text-reveal-wrapper">
            <h1 class="hero-title">Conservation<br>of Energy</h1>
            <p style="margin-top: 2rem; font-size: 1.4rem; max-width: 40ch;">
                Energy cannot be created or destroyed, only transformed from one form to another. The total energy in an
                isolated system remains constant.
            </p>
        </div>
    </section>

    <!-- CHAPTER 1: THE PRINCIPLE -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--accent);">01. The Principle</h3>
                <h2>Energy Transformation</h2>
                <p>
                    A simple pendulum is a classic example of energy transformation. As the pendulum swings downwards,
                    it loses gravitational potential energy ($PE$) and gains kinetic energy ($KE$). As it swings
                    upwards, the reverse process occurs.
                </p>
                <div class="math-block">
                    $$E_{total} = KE + PE = \text{constant}$$
                </div>

                <!-- ETU CARD -->
                <div class="etu-card">
                    <span class="etu-tag">Real World System</span>
                    <h4 style="margin-bottom:0.5rem;">Friction and Heat</h4>
                    <p style="font-size: 0.95rem; margin-bottom:0;">
                        In reality, complete isolation is impossible. Air resistance and friction at the pivot slowly
                        transform the pendulum's mechanical energy into thermal energy (heat), dampening the swing over
                        time. The energy isn't lost, just transformed into a less useful form.
                    </p>
                </div>

                <!-- AI LINKS -->
                <div class="ai-links">
                    <span class="ai-label">Ask AI:</span>
                    <button onclick="openAI('energy_pendulum', 'perplexity')" class="ai-btn" title="Ask Perplexity"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.3977 7.0896h-2.3106V.0676l-7.5094 6.3542V.1577h-1.1554v6.1966L4.4904 0v7.0896H1.6023v10.3976h2.8882V24l6.932-6.3591v6.2005h1.1554v-6.0469l6.9318 6.1807v-6.4879h2.8882V7.0896zm-3.4657-4.531v4.531h-5.355l5.355-4.531zm-13.2862.0676 4.8691 4.4634H5.6458V2.6262zM2.7576 16.332V8.245h7.8476l-6.1149 6.1147v1.9723H2.7576zm2.8882 5.0404v-3.8852h.0001v-2.6488l5.7763-5.7764v7.0111l-5.7764 5.2993zm12.7086.0248-5.7766-5.1509V9.0618l5.7766 5.7766v6.5588zm2.8882-5.0652h-1.733v-1.9723L13.3948 8.245h7.8478v8.087z" />
                        </svg></button>
                    <button onclick="openAI('energy_pendulum', 'gemini')" class="ai-btn" title="Ask Gemini"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11.04 19.32Q12 21.51 12 24q0-2.49.93-4.68.96-2.19 2.58-3.81t3.81-2.55Q21.51 12 24 12q-2.49 0-4.68-.93a12.3 12.3 0 0 1-3.81-2.58 12.3 12.3 0 0 1-2.58-3.81Q12 2.49 12 0q0 2.49-.96 4.68-.93 2.19-2.55 3.81a12.3 12.3 0 0 1-3.81 2.58Q2.49 12 0 12q2.49 0 4.68.96 2.19.93 3.81 2.55t2.55 3.81" />
                        </svg></button>
                    <button onclick="openAI('energy_pendulum', 'chatgpt')" class="ai-btn" title="Ask ChatGPT"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
                        </svg></button>
                    <button onclick="openAI('energy_pendulum', 'claude')" class="ai-btn" title="Ask Claude"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.64">
                            <path fill="#D77655"
                                d="M115.612 0h280.775C459.974 0 512 52.026 512 115.612v278.415c0 63.587-52.026 115.612-115.613 115.612H115.612C52.026 509.639 0 457.614 0 394.027V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#FCF2EE" fill-rule="nonzero"
                                d="M142.27 316.619l73.655-41.326 1.238-3.589-1.238-1.996-3.589-.001-12.31-.759-42.084-1.138-36.498-1.516-35.361-1.896-8.897-1.895-8.34-10.995.859-5.484 7.482-5.03 10.717.935 23.683 1.617 35.537 2.452 25.782 1.517 38.193 3.968h6.064l.86-2.451-2.073-1.517-1.618-1.517-36.776-24.922-39.81-26.338-20.852-15.166-11.273-7.683-5.687-7.204-2.451-15.721 10.237-11.273 13.75.935 3.513.936 13.928 10.716 29.749 23.027 38.848 28.612 5.687 4.727 2.275-1.617.278-1.138-2.553-4.271-21.13-38.193-22.546-38.848-10.035-16.101-2.654-9.655c-.935-3.968-1.617-7.304-1.617-11.374l11.652-15.823 6.445-2.073 15.545 2.073 6.547 5.687 9.655 22.092 15.646 34.78 24.265 47.291 7.103 14.028 3.791 12.992 1.416 3.968 2.449-.001v-2.275l1.997-26.641 3.69-32.707 3.589-42.084 1.239-11.854 5.863-14.206 11.652-7.683 9.099 4.348 7.482 10.716-1.036 6.926-4.449 28.915-8.72 45.294-5.687 30.331h3.313l3.792-3.791 15.342-20.372 25.782-32.227 11.374-12.789 13.27-14.129 8.517-6.724 16.1-.001 11.854 17.617-5.307 18.199-16.581 21.029-13.75 17.819-19.716 26.54-12.309 21.231 1.138 1.694 2.932-.278 44.536-9.479 24.062-4.347 28.714-4.928 12.992 6.066 1.416 6.167-5.106 12.613-30.71 7.583-36.018 7.204-53.636 12.689-.657.48.758.935 24.164 2.275 10.337.556h25.301l47.114 3.514 12.309 8.139 7.381 9.959-1.238 7.583-18.957 9.655-25.579-6.066-59.702-14.205-20.474-5.106-2.83-.001v1.694l17.061 16.682 31.266 28.233 39.152 36.397 1.997 8.999-5.03 7.102-5.307-.758-34.401-25.883-13.27-11.651-30.053-25.302-1.996-.001v2.654l6.926 10.136 36.574 54.975 1.895 16.859-2.653 5.485-9.479 3.311-10.414-1.895-21.408-30.054-22.092-33.844-17.819-30.331-2.173 1.238-10.515 113.261-4.929 5.788-11.374 4.348-9.478-7.204-5.03-11.652 5.03-23.027 6.066-30.052 4.928-23.886 4.449-29.674 2.654-9.858-.177-.657-2.173.278-22.37 30.71-34.021 45.977-26.919 28.815-6.445 2.553-11.173-5.789 1.037-10.337 6.243-9.2 37.257-47.392 22.47-29.371 14.508-16.961-.101-2.451h-.859l-98.954 64.251-17.618 2.275-7.583-7.103.936-11.652 3.589-3.791 29.749-20.474-.101.102.024.101z" />
                        </svg></button>
                    <button onclick="openAI('energy_pendulum', 'grok')" class="ai-btn" title="Ask Grok"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.641">
                            <path
                                d="M115.612 0h280.776C459.975 0 512 52.026 512 115.612v278.416c0 63.587-52.025 115.613-115.612 115.613H115.612C52.026 509.641 0 457.615 0 394.028V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#fff"
                                d="M213.235 306.019l178.976-180.002v.169l51.695-51.763c-.924 1.32-1.86 2.605-2.785 3.89-39.281 54.164-58.46 80.649-43.07 146.922l-.09-.101c10.61 45.11-.744 95.137-37.398 131.836-46.216 46.306-120.167 56.611-181.063 14.928l42.462-19.675c38.863 15.278 81.392 8.57 111.947-22.03 30.566-30.6 37.432-75.159 22.065-112.252-2.92-7.025-11.67-8.795-17.792-4.263l-124.947 92.341zm-25.786 22.437l-.033.034L68.094 435.217c7.565-10.429 16.957-20.294 26.327-30.149 26.428-27.803 52.653-55.359 36.654-94.302-21.422-52.112-8.952-113.177 30.724-152.898 41.243-41.254 101.98-51.661 152.706-30.758 11.23 4.172 21.016 10.114 28.638 15.639l-42.359 19.584c-39.44-16.563-84.629-5.299-112.207 22.313-37.298 37.308-44.84 102.003-1.128 143.81z" />
                        </svg></button>
                </div>

                <div class="sim-controls">
                    <div style="margin-bottom: 1rem;">
                        <button id="btn-release1"
                            style="width: 100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:4px; font-weight:600; cursor:pointer;">Release
                            Pendulum</button>
                    </div>
                    <div class="slider-group">
                        <label>Initial Angle (<span id="val-angle">45</span>°)</label>
                        <input type="range" id="input-angle" min="10" max="80" step="1" value="45">
                    </div>
                    <div class="slider-group">
                        <label>Damping/Friction (<span id="val-damping">0.0</span>)</label>
                        <input type="range" id="input-damping" min="0" max="0.05" step="0.005" value="0.0">
                    </div>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-pendulum" style="background: rgba(0,0,0,0.02);"></canvas>
            </div>
        </div>
    </section>

    <!-- CHAPTER 2: KINETIC & POTENTIAL -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--accent-secondary);">02. Gravitational Potential to Kinetic
                </h3>
                <h2>The Rollercoaster Drop</h2>
                <p>
                    Gravitational potential energy depends on an object's mass and height. As it falls, this energy is
                    converted linearly into kinetic energy. If it drops without friction, all $PE$ turns into $KE$.
                </p>
                <div class="math-block">
                    $$PE = mgh \quad \rightarrow \quad KE = \frac{1}{2}mv^2$$
                </div>

                <!-- AI LINKS -->
                <div class="ai-links">
                    <span class="ai-label">Ask AI:</span>
                    <button onclick="openAI('energy_rollercoaster', 'perplexity')" class="ai-btn"
                        title="Ask Perplexity"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.3977 7.0896h-2.3106V.0676l-7.5094 6.3542V.1577h-1.1554v6.1966L4.4904 0v7.0896H1.6023v10.3976h2.8882V24l6.932-6.3591v6.2005h1.1554v-6.0469l6.9318 6.1807v-6.4879h2.8882V7.0896zm-3.4657-4.531v4.531h-5.355l5.355-4.531zm-13.2862.0676 4.8691 4.4634H5.6458V2.6262zM2.7576 16.332V8.245h7.8476l-6.1149 6.1147v1.9723H2.7576zm2.8882 5.0404v-3.8852h.0001v-2.6488l5.7763-5.7764v7.0111l-5.7764 5.2993zm12.7086.0248-5.7766-5.1509V9.0618l5.7766 5.7766v6.5588zm2.8882-5.0652h-1.733v-1.9723L13.3948 8.245h7.8478v8.087z" />
                        </svg></button>
                    <button onclick="openAI('energy_rollercoaster', 'gemini')" class="ai-btn" title="Ask Gemini"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11.04 19.32Q12 21.51 12 24q0-2.49.93-4.68.96-2.19 2.58-3.81t3.81-2.55Q21.51 12 24 12q-2.49 0-4.68-.93a12.3 12.3 0 0 1-3.81-2.58 12.3 12.3 0 0 1-2.58-3.81Q12 2.49 12 0q0 2.49-.96 4.68-.93 2.19-2.55 3.81a12.3 12.3 0 0 1-3.81 2.58Q2.49 12 0 12q2.49 0 4.68.96 2.19.93 3.81 2.55t2.55 3.81" />
                        </svg></button>
                    <button onclick="openAI('energy_rollercoaster', 'chatgpt')" class="ai-btn" title="Ask ChatGPT"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
                        </svg></button>
                    <button onclick="openAI('energy_rollercoaster', 'claude')" class="ai-btn" title="Ask Claude"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.64">
                            <path fill="#D77655"
                                d="M115.612 0h280.775C459.974 0 512 52.026 512 115.612v278.415c0 63.587-52.026 115.612-115.613 115.612H115.612C52.026 509.639 0 457.614 0 394.027V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#FCF2EE" fill-rule="nonzero"
                                d="M142.27 316.619l73.655-41.326 1.238-3.589-1.238-1.996-3.589-.001-12.31-.759-42.084-1.138-36.498-1.516-35.361-1.896-8.897-1.895-8.34-10.995.859-5.484 7.482-5.03 10.717.935 23.683 1.617 35.537 2.452 25.782 1.517 38.193 3.968h6.064l.86-2.451-2.073-1.517-1.618-1.517-36.776-24.922-39.81-26.338-20.852-15.166-11.273-7.683-5.687-7.204-2.451-15.721 10.237-11.273 13.75.935 3.513.936 13.928 10.716 29.749 23.027 38.848 28.612 5.687 4.727 2.275-1.617.278-1.138-2.553-4.271-21.13-38.193-22.546-38.848-10.035-16.101-2.654-9.655c-.935-3.968-1.617-7.304-1.617-11.374l11.652-15.823 6.445-2.073 15.545 2.073 6.547 5.687 9.655 22.092 15.646 34.78 24.265 47.291 7.103 14.028 3.791 12.992 1.416 3.968 2.449-.001v-2.275l1.997-26.641 3.69-32.707 3.589-42.084 1.239-11.854 5.863-14.206 11.652-7.683 9.099 4.348 7.482 10.716-1.036 6.926-4.449 28.915-8.72 45.294-5.687 30.331h3.313l3.792-3.791 15.342-20.372 25.782-32.227 11.374-12.789 13.27-14.129 8.517-6.724 16.1-.001 11.854 17.617-5.307 18.199-16.581 21.029-13.75 17.819-19.716 26.54-12.309 21.231 1.138 1.694 2.932-.278 44.536-9.479 24.062-4.347 28.714-4.928 12.992 6.066 1.416 6.167-5.106 12.613-30.71 7.583-36.018 7.204-53.636 12.689-.657.48.758.935 24.164 2.275 10.337.556h25.301l47.114 3.514 12.309 8.139 7.381 9.959-1.238 7.583-18.957 9.655-25.579-6.066-59.702-14.205-20.474-5.106-2.83-.001v1.694l17.061 16.682 31.266 28.233 39.152 36.397 1.997 8.999-5.03 7.102-5.307-.758-34.401-25.883-13.27-11.651-30.053-25.302-1.996-.001v2.654l6.926 10.136 36.574 54.975 1.895 16.859-2.653 5.485-9.479 3.311-10.414-1.895-21.408-30.054-22.092-33.844-17.819-30.331-2.173 1.238-10.515 113.261-4.929 5.788-11.374 4.348-9.478-7.204-5.03-11.652 5.03-23.027 6.066-30.052 4.928-23.886 4.449-29.674 2.654-9.858-.177-.657-2.173.278-22.37 30.71-34.021 45.977-26.919 28.815-6.445 2.553-11.173-5.789 1.037-10.337 6.243-9.2 37.257-47.392 22.47-29.371 14.508-16.961-.101-2.451h-.859l-98.954 64.251-17.618 2.275-7.583-7.103.936-11.652 3.589-3.791 29.749-20.474-.101.102.024.101z" />
                        </svg></button>
                    <button onclick="openAI('energy_rollercoaster', 'grok')" class="ai-btn" title="Ask Grok"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.641">
                            <path
                                d="M115.612 0h280.776C459.975 0 512 52.026 512 115.612v278.416c0 63.587-52.025 115.613-115.612 115.613H115.612C52.026 509.641 0 457.615 0 394.028V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#fff"
                                d="M213.235 306.019l178.976-180.002v.169l51.695-51.763c-.924 1.32-1.86 2.605-2.785 3.89-39.281 54.164-58.46 80.649-43.07 146.922l-.09-.101c10.61 45.11-.744 95.137-37.398 131.836-46.216 46.306-120.167 56.611-181.063 14.928l42.462-19.675c38.863 15.278 81.392 8.57 111.947-22.03 30.566-30.6 37.432-75.159 22.065-112.252-2.92-7.025-11.67-8.795-17.792-4.263l-124.947 92.341zm-25.786 22.437l-.033.034L68.094 435.217c7.565-10.429 16.957-20.294 26.327-30.149 26.428-27.803 52.653-55.359 36.654-94.302-21.422-52.112-8.952-113.177 30.724-152.898 41.243-41.254 101.98-51.661 152.706-30.758 11.23 4.172 21.016 10.114 28.638 15.639l-42.359 19.584c-39.44-16.563-84.629-5.299-112.207 22.313-37.298 37.308-44.84 102.003-1.128 143.81z" />
                        </svg></button>
                </div>

                <div class="sim-controls">
                    <div style="margin-bottom: 1rem;">
                        <button id="btn-drop2"
                            style="width: 100%; padding:12px; background:var(--accent-secondary); color:white; border:none; border-radius:4px; font-weight:600; cursor:pointer;">Drop
                            Cart</button>
                    </div>
                    <div class="slider-group">
                        <label>Drop Height <span id="val-height">100</span> m</label>
                        <input type="range" id="input-height" min="20" max="150" step="5" value="100">
                    </div>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-rollercoaster" style="background: rgba(0,0,0,0.02);"></canvas>
            </div>
        </div>
    </section>

    <!-- CHAPTER 3: ELASTIC POTENTIAL -->
    <section>
        <div class="split-layout">
            <div class="content-col">
                <h3 class="section-label" style="color: var(--text-main);">03. Elastic Potential Energy</h3>
                <h2>Springs and Oscillation</h2>
                <p>
                    Energy can also be stored in the deformation of elastic materials, like springs. The energy stored
                    is proportional to the square of the displacement $x$ from equilibrium.
                </p>
                <div class="math-block">
                    $$PE_{elastic} = \frac{1}{2}kx^2$$
                </div>

                <!-- AI LINKS -->
                <div class="ai-links">
                    <span class="ai-label">Ask AI:</span>
                    <button onclick="openAI('energy_spring', 'perplexity')" class="ai-btn" title="Ask Perplexity"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.3977 7.0896h-2.3106V.0676l-7.5094 6.3542V.1577h-1.1554v6.1966L4.4904 0v7.0896H1.6023v10.3976h2.8882V24l6.932-6.3591v6.2005h1.1554v-6.0469l6.9318 6.1807v-6.4879h2.8882V7.0896zm-3.4657-4.531v4.531h-5.355l5.355-4.531zm-13.2862.0676 4.8691 4.4634H5.6458V2.6262zM2.7576 16.332V8.245h7.8476l-6.1149 6.1147v1.9723H2.7576zm2.8882 5.0404v-3.8852h.0001v-2.6488l5.7763-5.7764v7.0111l-5.7764 5.2993zm12.7086.0248-5.7766-5.1509V9.0618l5.7766 5.7766v6.5588zm2.8882-5.0652h-1.733v-1.9723L13.3948 8.245h7.8478v8.087z" />
                        </svg></button>
                    <button onclick="openAI('energy_spring', 'gemini')" class="ai-btn" title="Ask Gemini"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11.04 19.32Q12 21.51 12 24q0-2.49.93-4.68.96-2.19 2.58-3.81t3.81-2.55Q21.51 12 24 12q-2.49 0-4.68-.93a12.3 12.3 0 0 1-3.81-2.58 12.3 12.3 0 0 1-2.58-3.81Q12 2.49 12 0q0 2.49-.96 4.68-.93 2.19-2.55 3.81a12.3 12.3 0 0 1-3.81 2.58Q2.49 12 0 12q2.49 0 4.68.96 2.19.93 3.81 2.55t2.55 3.81" />
                        </svg></button>
                    <button onclick="openAI('energy_spring', 'chatgpt')" class="ai-btn" title="Ask ChatGPT"><svg
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
                        </svg></button>
                    <button onclick="openAI('energy_spring', 'claude')" class="ai-btn" title="Ask Claude"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.64">
                            <path fill="#D77655"
                                d="M115.612 0h280.775C459.974 0 512 52.026 512 115.612v278.415c0 63.587-52.026 115.612-115.613 115.612H115.612C52.026 509.639 0 457.614 0 394.027V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#FCF2EE" fill-rule="nonzero"
                                d="M142.27 316.619l73.655-41.326 1.238-3.589-1.238-1.996-3.589-.001-12.31-.759-42.084-1.138-36.498-1.516-35.361-1.896-8.897-1.895-8.34-10.995.859-5.484 7.482-5.03 10.717.935 23.683 1.617 35.537 2.452 25.782 1.517 38.193 3.968h6.064l.86-2.451-2.073-1.517-1.618-1.517-36.776-24.922-39.81-26.338-20.852-15.166-11.273-7.683-5.687-7.204-2.451-15.721 10.237-11.273 13.75.935 3.513.936 13.928 10.716 29.749 23.027 38.848 28.612 5.687 4.727 2.275-1.617.278-1.138-2.553-4.271-21.13-38.193-22.546-38.848-10.035-16.101-2.654-9.655c-.935-3.968-1.617-7.304-1.617-11.374l11.652-15.823 6.445-2.073 15.545 2.073 6.547 5.687 9.655 22.092 15.646 34.78 24.265 47.291 7.103 14.028 3.791 12.992 1.416 3.968 2.449-.001v-2.275l1.997-26.641 3.69-32.707 3.589-42.084 1.239-11.854 5.863-14.206 11.652-7.683 9.099 4.348 7.482 10.716-1.036 6.926-4.449 28.915-8.72 45.294-5.687 30.331h3.313l3.792-3.791 15.342-20.372 25.782-32.227 11.374-12.789 13.27-14.129 8.517-6.724 16.1-.001 11.854 17.617-5.307 18.199-16.581 21.029-13.75 17.819-19.716 26.54-12.309 21.231 1.138 1.694 2.932-.278 44.536-9.479 24.062-4.347 28.714-4.928 12.992 6.066 1.416 6.167-5.106 12.613-30.71 7.583-36.018 7.204-53.636 12.689-.657.48.758.935 24.164 2.275 10.337.556h25.301l47.114 3.514 12.309 8.139 7.381 9.959-1.238 7.583-18.957 9.655-25.579-6.066-59.702-14.205-20.474-5.106-2.83-.001v1.694l17.061 16.682 31.266 28.233 39.152 36.397 1.997 8.999-5.03 7.102-5.307-.758-34.401-25.883-13.27-11.651-30.053-25.302-1.996-.001v2.654l6.926 10.136 36.574 54.975 1.895 16.859-2.653 5.485-9.479 3.311-10.414-1.895-21.408-30.054-22.092-33.844-17.819-30.331-2.173 1.238-10.515 113.261-4.929 5.788-11.374 4.348-9.478-7.204-5.03-11.652 5.03-23.027 6.066-30.052 4.928-23.886 4.449-29.674 2.654-9.858-.177-.657-2.173.278-22.37 30.71-34.021 45.977-26.919 28.815-6.445 2.553-11.173-5.789 1.037-10.337 6.243-9.2 37.257-47.392 22.47-29.371 14.508-16.961-.101-2.451h-.859l-98.954 64.251-17.618 2.275-7.583-7.103.936-11.652 3.589-3.791 29.749-20.474-.101.102.024.101z" />
                        </svg></button>
                    <button onclick="openAI('energy_spring', 'grok')" class="ai-btn" title="Ask Grok"><svg
                            xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision"
                            text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd"
                            clip-rule="evenodd" viewBox="0 0 512 509.641">
                            <path
                                d="M115.612 0h280.776C459.975 0 512 52.026 512 115.612v278.416c0 63.587-52.025 115.613-115.612 115.613H115.612C52.026 509.641 0 457.615 0 394.028V115.612C0 52.026 52.026 0 115.612 0z" />
                            <path fill="#fff"
                                d="M213.235 306.019l178.976-180.002v.169l51.695-51.763c-.924 1.32-1.86 2.605-2.785 3.89-39.281 54.164-58.46 80.649-43.07 146.922l-.09-.101c10.61 45.11-.744 95.137-37.398 131.836-46.216 46.306-120.167 56.611-181.063 14.928l42.462-19.675c38.863 15.278 81.392 8.57 111.947-22.03 30.566-30.6 37.432-75.159 22.065-112.252-2.92-7.025-11.67-8.795-17.792-4.263l-124.947 92.341zm-25.786 22.437l-.033.034L68.094 435.217c7.565-10.429 16.957-20.294 26.327-30.149 26.428-27.803 52.653-55.359 36.654-94.302-21.422-52.112-8.952-113.177 30.724-152.898 41.243-41.254 101.98-51.661 152.706-30.758 11.23 4.172 21.016 10.114 28.638 15.639l-42.359 19.584c-39.44-16.563-84.629-5.299-112.207 22.313-37.298 37.308-44.84 102.003-1.128 143.81z" />
                        </svg></button>
                </div>

                <div class="sim-controls">
                    <div style="margin-bottom: 1rem;">
                        <button id="btn-pull3"
                            style="width: 100%; padding:12px; background:var(--text-main); color:var(--bg-color); border:none; border-radius:4px; font-weight:600; cursor:pointer;">Pull
                            & Release Spring</button>
                    </div>
                    <div class="slider-group">
                        <label>Spring Constant $(k)$ <span id="val-k">20</span> N/m</label>
                        <input type="range" id="input-k" min="5" max="50" step="5" value="20">
                    </div>
                    <div class="slider-group">
                        <label>Amplitude $(x)$ <span id="val-x">50</span> cm</label>
                        <input type="range" id="input-x" min="10" max="100" step="10" value="50">
                    </div>
                    <div class="slider-group">
                        <label>Damping/Friction <span id="val-spring-damping">0.02</span></label>
                        <input type="range" id="input-spring-damping" min="0" max="0.1" step="0.01" value="0.02">
                    </div>
                </div>
            </div>
            <div class="visual-col">
                <canvas id="canvas-spring" style="background: rgba(0,0,0,0.02);"></canvas>
            </div>
        </div>
    </section>

    <div class="divider"></div>

    <section class="references">
        <div style="max-width: 800px; margin: 0 auto;">
            <h3>Academic References</h3>
            <ul>
                <li><strong>Joule, J. P.</strong> (1845). <em>On the Mechanical Equivalent of Heat</em>.</li>
                <li><strong>Feynman, R. P.</strong> (1963). <em>The Feynman Lectures on Physics, Vol. 1</em>
                    (Conservation of Energy).</li>
            </ul>
        </div>
    </section>

    <!-- Scripts -->
    <script src="../js/common.js"></script>
    <script>
        function openAI(topic, model) {
            let prompt = "";
            switch (topic) {
                case 'energy_pendulum': prompt = "Explain the conservation of energy using a simple pendulum as an example. How do kinetic and potential energy transform into one another?"; break;
                case 'energy_rollercoaster': prompt = "Explain the relationship between gravitational potential energy and kinetic energy in the context of a rollercoaster dropping from a height."; break;
                case 'energy_spring': prompt = "Explain elastic potential energy using Hooke's Law and a spring-mass system. How is energy conserved when a spring oscillates?"; break;
            }
            const encoded = encodeURIComponent(prompt);

            if (model === 'gemini') {
                navigator.clipboard.writeText(prompt).then(() => {
                    alert("Gemini doesn't support auto-fill. The prompt has been copied to your clipboard.");
                    window.open('https://gemini.google.com/app', '_blank');
                });
                return;
            }

            let url = "";
            switch (model) {
                case 'perplexity': url = `https://www.perplexity.ai/search?q=${encoded}`; break;
                case 'chatgpt': url = `https://chatgpt.com/?q=${encoded}`; break;
                case 'claude': url = `https://claude.ai/new?q=${encoded}`; break;
                case 'grok': url = `https://grok.com/?q=${encoded}`; break;
            }
            if (url) window.open(url, '_blank');
        }

        const APP = {
            visuals: [],
            observer: null,
            init() {
                this.setupObserver();
                this.initScrollAnimations();
                this.initVisuals();
                window.addEventListener('theme-changed', () => this.visuals.forEach(v => v.updateColors()));
            },
            setupObserver() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const visual = this.visuals.find(v => v.canvas === entry.target);
                        if (visual) visual.isVisible = entry.isIntersecting;
                    });
                }, { threshold: 0.1 });
            },
            initScrollAnimations() {
                gsap.registerPlugin(ScrollTrigger);
                gsap.utils.toArray('h1, h2, h3').forEach(el => gsap.from(el, { opacity: 0, y: 30, duration: 1.2, ease: "power3.out", scrollTrigger: { trigger: el, start: "top 85%" } }));
                gsap.utils.toArray('.math-block').forEach(el => gsap.from(el, { scale: 0.95, opacity: 0, duration: 1, ease: "power2.out", scrollTrigger: { trigger: el, start: "top 90%" } }));
            },
            initVisuals() {
                this.addVisual(new PendulumSim('canvas-pendulum'));
                this.addVisual(new RollercoasterSim('canvas-rollercoaster'));
                this.addVisual(new SpringSim('canvas-spring'));
            },
            addVisual(visual) {
                this.visuals.push(visual);
                this.observer.observe(visual.canvas);
            }
        };

        class BaseSim {
            constructor(id) {
                this.canvas = document.getElementById(id);
                this.ctx = this.canvas.getContext('2d');
                this.isVisible = false;
                this.updateColors();
                this.resize();
                window.addEventListener('resize', () => this.resize());
                setTimeout(() => { this.resize(); this.loop(); }, 50);
            }
            updateColors() {
                this.color = getComputedStyle(document.body).getPropertyValue('--text-main').trim();
                this.accent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
                this.accentSecondary = getComputedStyle(document.body).getPropertyValue('--accent-secondary').trim();
                this.bgColor = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
            }
            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                // Ensure layout correctly fits parent without overflowing
                this.canvas.style.width = '100%';
                this.canvas.style.height = '100%';
                this.scale = window.devicePixelRatio || 2;
                this.canvas.width = rect.width * this.scale;
                this.canvas.height = rect.height * this.scale;
                this.w = rect.width;
                this.h = rect.height;
            }
            loop() {
                if (this.isVisible) this.draw();
                requestAnimationFrame(() => this.loop());
            }
            draw() { }
            // Helper to draw energy bars that scale with device resolution
            drawEnergyBar(x, y, label, labelColor, fillLevel, fillColor, maxH = 100) {
                const w = 30 * this.scale;
                const h = maxH * this.scale;
                const filledH = (fillLevel * maxH) * this.scale;
                const px = x * this.scale;
                const py = y * this.scale;

                // Track outline
                this.ctx.strokeStyle = this.color;
                this.ctx.globalAlpha = 0.3;
                this.ctx.strokeRect(px, py - h, w, h);
                this.ctx.globalAlpha = 1.0;

                // Track fill
                this.ctx.fillStyle = fillColor || labelColor;
                this.ctx.fillRect(px, py - filledH, w, filledH);

                // Label
                this.ctx.fillStyle = labelColor;
                const fontSize = 14 * this.scale;
                this.ctx.font = `500 ${fontSize}px sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.fillText(label, px + w / 2, py + (20 * this.scale));
            }
        }

        // ==========================
        // 1. PENDULUM SIM
        // ==========================
        class PendulumSim extends BaseSim {
            constructor(id) {
                super(id);
                this.angle = 45 * Math.PI / 180;
                this.velocity = 0;
                this.length = 150;
                this.gravity = 0.5;
                this.damping = 0;
                this.running = false;

                this.initialAngle = this.angle;

                const inputAngle = document.getElementById('input-angle');
                const inputDamping = document.getElementById('input-damping');
                const btnRelease = document.getElementById('btn-release1');

                inputAngle.addEventListener('input', (e) => {
                    if (this.running) return;
                    document.getElementById('val-angle').innerText = e.target.value;
                    this.angle = parseFloat(e.target.value) * Math.PI / 180;
                    this.initialAngle = this.angle;
                    this.velocity = 0;
                });

                inputDamping.addEventListener('input', (e) => {
                    document.getElementById('val-damping').innerText = e.target.value;
                    this.damping = parseFloat(e.target.value);
                });

                btnRelease.addEventListener('click', () => {
                    if (!this.running) {
                        this.running = true;
                        btnRelease.innerText = "Stop / Reset";
                    } else {
                        this.running = false;
                        this.angle = this.initialAngle;
                        this.velocity = 0;
                        btnRelease.innerText = "Release Pendulum";
                    }
                });
            }
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (this.running) {
                    let acceleration = (-1 * this.gravity / this.length) * Math.sin(this.angle);
                    this.velocity += acceleration;
                    this.velocity *= (1 - this.damping); // Apply damping/friction
                    this.angle += this.velocity;
                }

                // Pivot point
                const px = this.canvas.width / 2;
                const py = 50 * this.scale;

                // Bob pos
                const scaledL = this.length * this.scale;
                const bx = px + scaledL * Math.sin(this.angle);
                const by = py + scaledL * Math.cos(this.angle);

                // Draw string
                this.ctx.beginPath();
                this.ctx.moveTo(px, py);
                this.ctx.lineTo(bx, by);
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = 2 * this.scale;
                this.ctx.stroke();

                // Draw bob
                this.ctx.beginPath();
                this.ctx.arc(bx, by, 15 * this.scale, 0, 2 * Math.PI);
                this.ctx.fillStyle = this.accent;
                this.ctx.fill();

                // Calculate energies loosely based on max height.
                const hMax = this.length * (1 - Math.cos(this.initialAngle));
                const hCur = this.length * (1 - Math.cos(this.angle));

                let pePercent = hCur / hMax;
                let kePercent = (this.velocity * this.velocity * this.length * 10) / hMax;
                // clamp due to loose physics estimation for visualization
                if (pePercent > 1) pePercent = 1; if (pePercent < 0) pePercent = 0;
                if (kePercent > 1) kePercent = 1; if (kePercent < 0) kePercent = 0;

                // Account for energy lost to damping visually shrinking total energy pool
                const currentMaxEnergy = this.running && this.damping > 0 ? (Math.abs(this.angle) / this.initialAngle) : 1;

                this.drawEnergyBar(this.w - 180, this.h - 50, "PE", this.accent, pePercent * currentMaxEnergy);
                this.drawEnergyBar(this.w - 120, this.h - 50, "KE", "#3498db", kePercent * currentMaxEnergy);
                this.drawEnergyBar(this.w - 60, this.h - 50, "Total", this.color, currentMaxEnergy, "rgba(100,100,100,0.5)");
            }
        }

        // ==========================
        // 2. ROLLERCOASTER SIM (Physics Based)
        // ==========================
        class RollercoasterSim extends BaseSim {
            constructor(id) {
                super(id);
                this.dropHeight = 100;
                this.gravity = 9.8;

                // Track geometry based on 0 to 1 domain.
                this.trackPoints = [
                    { x: 0.1, y: 1.0 },   // Top start
                    { x: 0.3, y: 1.0 },   // Initial flat
                    { x: 0.6, y: 0.05 },  // Bottom of drop
                    { x: 0.9, y: 0.05 },  // End of flat
                    { x: 1.0, y: 0.05 }
                ];

                this.cartSpeed = 0; // m/s
                this.cartPos = 0.1; // parameter t in tracking points

                this.running = false;

                document.getElementById('input-height').addEventListener('input', e => {
                    this.dropHeight = parseFloat(e.target.value);
                    document.getElementById('val-height').innerText = this.dropHeight;
                    this.resetCart();
                });

                document.getElementById('btn-drop2').addEventListener('click', () => {
                    if (this.running) this.resetCart();
                    else {
                        this.running = true;
                        document.getElementById('btn-drop2').innerText = "Reset Cart";
                    }
                });
                this.resetCart();
            }

            resetCart() {
                this.running = false;
                this.cartSpeed = 0;
                this.cartPos = 0.05; // Start x param
                document.getElementById('btn-drop2').innerText = "Drop Cart";
            }

            // Helper to interpolate cubic curved track
            getTrackY(xParam) {
                if (xParam <= 0.1) return 1.0;
                if (xParam >= 0.7) return 0.05;

                // Smoothstep between 0.1 and 0.7
                // t goes from 0 to 1
                let t = (xParam - 0.1) / 0.6;
                let smooth = t * t * (3 - 2 * t);
                return 1.0 - (smooth * 0.95);
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Pixel coordinates mapping
                const baseY = this.h - 50;
                // Height multiplier to convert 0-1 drop to pixels
                const hScaling = this.dropHeight * 1.5;
                const topY = baseY - hScaling;

                // Draw Track
                this.ctx.beginPath();
                for (let px = 0; px <= this.w; px += 2) {
                    let rx = px / this.w;
                    let ry = this.getTrackY(rx);
                    // Map ry (0: baseY, 1: topY) to pixels
                    let pixelY = baseY - (ry * hScaling);

                    if (px === 0) this.ctx.moveTo(px * this.scale, pixelY * this.scale);
                    else this.ctx.lineTo(px * this.scale, pixelY * this.scale);
                }
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = 4 * this.scale;
                this.ctx.stroke();

                // Physics Simulation Step
                const dt = 0.016 * 3.0; // Approx 60fps dt, scaled 1.25x for speed

                // Get tangent slope at current position for acceleration
                const deltaX = 0.001;
                const currentYTrack = this.getTrackY(this.cartPos);
                const peekYTrack = this.getTrackY(this.cartPos + deltaX);
                // dy is in track units. Need it relative to actual meters.
                const dy = peekYTrack - currentYTrack; // negative means going down
                const slopeAngle = Math.atan2(-dy * this.dropHeight, deltaX * this.w);

                // Physical gravity acceleration along the slope
                const acceleration = this.gravity * Math.sin(slopeAngle);

                if (this.running) {
                    if (this.cartSpeed === 0 && this.cartPos <= 0.1) this.cartSpeed = 1.0; // push
                    this.cartSpeed += acceleration * dt;
                    // Move position along track based on speed
                    // Normalize speed (m/s) to track domain width slightly
                    this.cartPos += (this.cartSpeed * dt) / (this.w / 2);

                    if (this.cartPos > 0.9) {
                        this.cartSpeed *= 0.95; // Add friction at the end to stop
                    }
                    if (this.cartPos > 1.2) this.resetCart();
                }

                // Render Cart
                let cy = this.getTrackY(this.cartPos);
                let cxPixel = this.cartPos * this.w;
                let cyPixel = baseY - (cy * hScaling);

                this.ctx.fillStyle = this.accentSecondary;
                this.ctx.beginPath();
                this.ctx.arc(cxPixel * this.scale, cyPixel * this.scale, 12 * this.scale, 0, Math.PI * 2);
                this.ctx.fill();

                // Energy Calculation Display
                // Max height represents total potential energy initially
                let currentHeightMeters = cy * this.dropHeight;
                let pe = this.gravity * currentHeightMeters; // per kg mass
                let maxPe = this.gravity * this.dropHeight;
                let ke = 0.5 * this.cartSpeed * this.cartSpeed; // per kg mass

                // Cap ke based on max energy to handle discrete step drift
                let tot = pe + ke;
                if (tot > maxPe) {
                    ke = maxPe - pe;
                    if (ke < 0) ke = 0;
                }

                this.ctx.textAlign = 'right';
                const fontSize = 16 * this.scale;
                this.ctx.font = `600 ${fontSize}px sans-serif`;
                this.ctx.fillStyle = this.color;
                this.ctx.fillText(`Speed: ${Math.abs(this.cartSpeed).toFixed(1)} m/s`, this.w - 20 * this.scale, 40 * this.scale);

                // Energy Bar Visualization (PE & KE)
                this.drawEnergyBar(this.w - 120, 140, "PE", this.accentSecondary, pe / maxPe, null, 60);
                this.drawEnergyBar(this.w - 60, 140, "KE", "#3498db", ke / maxPe, null, 60);
            }
        }

        // ==========================
        // 3. SPRING SIM (Physics Based)
        // ==========================
        class SpringSim extends BaseSim {
            constructor(id) {
                super(id);
                this.k = 20;
                this.amp = 50;
                this.mass = 5;
                this.damping = 0.02;

                this.pos = 0;
                this.vel = 0;
                this.running = false;

                this.thermalEnergy = 0;

                document.getElementById('input-k').addEventListener('input', e => {
                    this.k = parseFloat(e.target.value);
                    document.getElementById('val-k').innerText = this.k;
                });

                document.getElementById('input-x').addEventListener('input', e => {
                    this.amp = parseFloat(e.target.value);
                    document.getElementById('val-x').innerText = this.amp;
                    if (!this.running) this.pos = this.amp;
                });

                document.getElementById('input-spring-damping').addEventListener('input', e => {
                    this.damping = parseFloat(e.target.value);
                    document.getElementById('val-spring-damping').innerText = this.damping;
                });

                document.getElementById('btn-pull3').addEventListener('click', () => {
                    this.running = !this.running;
                    if (!this.running) {
                        this.vel = 0;
                        this.pos = this.amp; // Reset to pulled position
                        this.thermalEnergy = 0;
                        document.getElementById('btn-pull3').innerText = "Release Spring";
                    } else {
                        document.getElementById('btn-pull3').innerText = "Stop / Reset";
                        this.thermalEnergy = 0; // Reset thermal on new run
                    }
                });

                this.pos = this.amp; // initial resting but pulled position
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                const dt = 0.16; // Time step

                if (this.running) {
                    // Hooke's Law: F = -kx
                    // F_damping = -c * v
                    const springForce = -this.k * this.pos;
                    const dampingForce = -this.damping * this.vel * 100; // Scaled for visual effect

                    const accel = (springForce + dampingForce) / this.mass;

                    this.vel += accel * dt;
                    this.pos += this.vel * dt;

                    // Accumulate thermal energy from work done by friction: W = F_d * d
                    // Abstractly representing energy lost to heat
                    this.thermalEnergy += Math.abs(dampingForce * (this.vel * dt));
                }

                const px = (this.w / 2) * this.scale;
                const py = (this.h / 2) * this.scale;
                const blockX = px + (this.pos * 2 * this.scale); // *2 for visual scale

                // Wall
                this.ctx.fillStyle = this.color;
                this.ctx.fillRect(50 * this.scale, py - 40 * this.scale, 20 * this.scale, 80 * this.scale);

                // Spring
                this.ctx.beginPath();
                this.ctx.moveTo(70 * this.scale, py);
                const coils = 12;
                const springLen = blockX - (70 * this.scale);
                for (let i = 1; i <= coils; i++) {
                    const cx = (70 * this.scale) + (springLen / coils) * i - (springLen / (coils * 2));
                    const cy = py + (i % 2 === 0 ? 15 : -15) * this.scale;
                    this.ctx.lineTo(cx, cy);
                    this.ctx.lineTo(cx + (springLen / (coils * 2)), py);
                }
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = 2 * this.scale;
                this.ctx.stroke();

                // Block
                this.ctx.fillStyle = this.accent;
                this.ctx.fillRect(blockX, py - 30 * this.scale, 60 * this.scale, 60 * this.scale);

                // Energy Calculations (Actual physics equations)
                const maxEnergy = 0.5 * this.k * (this.amp * this.amp);
                const currentPE = 0.5 * this.k * (this.pos * this.pos);
                // KE = 1/2 m v^2. Scaling factors adjust for visual coordinates vs physical meters
                let currentKE = 0.5 * this.mass * (this.vel * this.vel) * 20;

                // Normalizing for visual bars
                let pePercent = currentPE / maxEnergy;
                let kePercent = currentKE / maxEnergy;
                let thPercent = this.thermalEnergy / maxEnergy;

                // Clamp for dirty physics rounding
                if (pePercent > 1) pePercent = 1; if (pePercent < 0) pePercent = 0;
                if (kePercent > 1) kePercent = 1; if (kePercent < 0) kePercent = 0;
                if (thPercent > 1) thPercent = 1;

                // Energy Bar Visualization
                this.drawEnergyBar(this.w - 180, this.h - 50, "PE", this.accent, pePercent);
                this.drawEnergyBar(this.w - 120, this.h - 50, "KE", "#3498db", kePercent);
                this.drawEnergyBar(this.w - 60, this.h - 50, "Heat", "#e74c3c", thPercent);
            }
        }

        window.onload = () => APP.init();
    </script>
</body>

</html>